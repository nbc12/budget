<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget - {{ month_display }}</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/public/css/autocomplete.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .income { color: green; font-weight: bold; }
        .expense { color: red; font-weight: bold; }
        .stats-card { text-align: center; padding: 15px; border-radius: 10px; background: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .chart-container { background: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px; }
        .table-container { background: white; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 30px; position: relative; }
        .section-header { margin-bottom: 15px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; }
        .autocomplete-wrapper { position: relative; z-index: 1050; }
        .autocomplete-items { z-index: 9999 !important; }
        .table td, .table th { overflow: visible !important; position: relative; white-space: nowrap; }
        .notes-col { min-width: 80px; white-space: normal !important; }
        .sticky-bottom { z-index: 1020; }
        .editing-row { position: relative; z-index: 1060 !important; }
        
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        @media (max-width: 768px) {
            .container { padding-left: 10px; padding-right: 10px; }
            .h2 { font-size: 1.5rem; }
            .stats-card { padding: 10px; }
            .h4 { font-size: 1.1rem; }
            .btn-sm { padding: 0.25rem 0.4rem; font-size: 0.75rem; }
            .table { font-size: 0.85rem; }
        }
    </style>
</head>
<body class="bg-light">
    <!-- Hidden Forms -->
    <form action="/categories" method="POST" id="add-category-form"></form>
    <form action="/budget/add" method="POST" id="add-transaction-form"></form>

    <div class="container py-4">
        <!-- Header & Navigation -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <button class="btn btn-outline-secondary btn-sm" onclick="changeMonth(-1)">← Prev</button>
            <div class="text-center">
                <h1 class="h2 mb-0">{{ month_display }}</h1>
                <div class="d-flex justify-content-center gap-2">
                    <button class="btn btn-link btn-sm p-0" data-bs-toggle="modal" data-bs-target="#manageCardsModal">Manage Cards</button>
                    <span class="text-muted">|</span>
                    <a href="/categories" class="btn btn-link btn-sm p-0 text-decoration-none">Manage Categories</a>
                </div>
            </div>
            <button class="btn btn-outline-secondary btn-sm" onclick="changeMonth(1)">Next →</button>
        </div>

        <!-- Financial Overview Dashboard -->
        <div class="row g-2 mb-4">
            <div class="col-4">
                <div class="stats-card">
                    <div class="text-muted small text-uppercase" style="font-size: 0.7rem;">Income</div>
                    <div class="h4 mb-0 income">${{ overview.total_income }}</div>
                </div>
            </div>
            <div class="col-4">
                <div class="stats-card">
                    <div class="text-muted small text-uppercase" style="font-size: 0.7rem;">Expenses</div>
                    <div class="h4 mb-0 expense">${{ overview.total_expenses }}</div>
                </div>
            </div>
            <div class="col-4">
                <div class="stats-card">
                    <div class="text-muted small text-uppercase" style="font-size: 0.7rem;">Net</div>
                    <div class="h4 mb-0 {% if overview.net_is_positive %}income{% else %}expense{% endif %}">
                        ${{ overview.net_balance }}
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Row 1 -->
        <div class="row mb-4">
            <div class="col-md-8 mb-4">
                <div class="chart-container" id="barChartContainer" style="height: auto;">
                    <canvas id="budgetBarChart"></canvas>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="expensePieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Budget Table -->
        <div class="section-header">
            <h2 class="h4 mb-0">Budget</h2>
        </div>
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="budget-table">
                    <thead class="table-light">
                        <tr>
                            <th style="width: 40px;"><input type="checkbox" id="filter-all" checked onchange="toggleAllFilters()"></th>
                            <th class="category-col">Category</th>
                            <th>Budget</th>
                            <th>Actual</th>
                            <th>Remaining</th>
                            <th style="width: 1%; white-space: nowrap;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in budget_rows %}
                        {% if row.is_active %}
                        <tr class="category-row" data-category-id="{{ row.category_id }}" data-color="{{ row.category_color }}" data-is-income="{{ row.is_income }}">
                            <td><input type="checkbox" class="category-filter" value="{{ row.category_id }}" checked onchange="applyFilters()"></td>
                            <td>
                                <span class="badge" style="background-color: {{ row.category_color }}; color: #333; border: 1px solid #ddd;">{{ row.category_name }}</span>
                                {% if row.is_income %}<small class="text-success ms-1">(Income)</small>{% endif %}
                            </td>
                            <td>
                                <div class="d-flex align-items-center">
                                    $<span class="limit-text" onclick="editLimit({{ row.category_id }})">{{ row.limit_dollars }}</span>
                                    <input type="number" step="0.01" class="form-control form-control-sm d-none limit-input" 
                                           value="{{ row.limit_dollars }}" onblur="saveLimit({{ row.category_id }})" 
                                           onkeydown="if(event.key==='Enter') this.blur()">
                                </div>
                            </td>
                            <td>
                                ${{ row.spent_dollars }}
                                <small class="text-muted" style="font-size: 0.75em;">({{ row.percent_spent }}%)</small>
                            </td>
                            <td>
                                ${{ row.remaining_dollars }}
                                <small class="text-muted" style="font-size: 0.75em;">({{ row.percent_remaining }}%)</small>
                            </td>
                            <td style="white-space: nowrap;">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editCategory({{ row.category_id }})">Edit</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteCategory({{ row.category_id }})">Delete</button>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-info">
                        <tr>
                            <td></td>
                            <td class="category-col">
                                <div class="d-flex gap-1 align-items-center">
                                    <input type="text" form="add-category-form" name="name" class="form-control form-control-sm" required placeholder="New Category...">
                                    <div class="form-check mb-0">
                                        <input class="form-check-input" type="checkbox" form="add-category-form" name="is_income" id="add-cat-is-income">
                                        <label class="small mb-0" for="add-cat-is-income">Inc</label>
                                    </div>
                                </div>
                            </td>
                            <td><input type="number" form="add-category-form" name="monthly_limit" id="add-category-limit" step="0.01" class="form-control form-control-sm" required placeholder="0.00" onkeydown="if(event.key==='Enter') document.getElementById('add-category-form').requestSubmit()"></td>
                            <td>--</td>
                            <td>--</td>
                            <td><button type="submit" form="add-category-form" class="btn btn-sm btn-primary w-100">Add</button></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Transactions Section -->
        <div class="section-header">
            <h2 class="h4 mb-0">Transactions</h2>
            <div class="d-flex align-items-center gap-2">
                <span class="small text-muted">Sort by:</span>
                <select class="form-select form-select-sm" id="sort-select" onchange="sortTransactions()" style="width: auto;">
                    <option value="date-desc">Date (Newest)</option>
                    <option value="date-asc">Date (Oldest)</option>
                    <option value="amount-desc">Amount (Highest)</option>
                    <option value="category">Category</option>
                    <option value="card">Card</option>
                </select>
            </div>
        </div>
        <div class="table-container">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>Date</th>
                            <th class="card-col">Card</th>
                            <th class="category-col">Category</th>
                            <th class="amount-col">Amount</th>
                            <th class="notes-col">Notes</th>
                            <th style="width: 1%; white-space: nowrap;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="transaction-table-body">
                        {% for t in transactions %}
                        <tr id="row-{{ t.id }}" 
                            data-id="{{ t.id }}" 
                            data-date="{{ t.transaction_date }}" 
                            data-category="{{ t.category_id }}" 
                            data-card="{{ t.card_id }}"
                            data-notes="{{ t.notes }}" 
                            data-amount-dollars="{{ t.amount_dollars }}"
                            data-is-income="{{ t.is_income }}">
                            <td>{{ t.transaction_date_display }}</td>
                            <td class="card-col">{{ t.card_name }}</td>
                            <td class="category-col">
                                <span class="badge" style="background-color: {{ t.category_color }}; color: #333; border: 1px solid #ddd;">{{ t.category_name }}</span>
                            </td>
                            <td class="amount-col {% if t.is_income %}income{% else %}expense{% endif %}">
                                ${{ t.amount_dollars }}
                            </td>
                            <td class="notes-col">{{ t.notes }}</td>
                            <td style="white-space: nowrap;">
                                <div class="d-flex gap-1">
                                    <button class="btn btn-sm btn-outline-primary" onclick="editRow({{ t.id }})">Edit</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete({{ t.id }})">Delete</button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                    <tfoot class="table-info sticky-bottom">
                        <tr>
                            <td><input type="date" form="add-transaction-form" name="transaction_date" class="form-control form-control-sm" required value="{{ month }}-01"></td>
                            <td class="card-col">
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="add-card-input" class="form-control form-control-sm" placeholder="Card...">
                                    <input type="hidden" form="add-transaction-form" name="card_id" id="add-card-id">
                                </div>
                            </td>
                            <td class="category-col">
                                <div class="autocomplete-wrapper">
                                    <input type="text" id="add-category-input" class="form-control form-control-sm" required placeholder="Category...">
                                    <input type="hidden" form="add-transaction-form" name="category_id" id="add-category-id">
                                </div>
                            </td>
                            <td class="amount-col">
                                <input type="number" form="add-transaction-form" name="amount_dollars" step="0.01" class="form-control form-control-sm" required placeholder="0.00">
                            </td>
                            <td class="notes-col"><input type="text" form="add-transaction-form" name="notes" class="form-control form-control-sm" placeholder="Notes" onkeydown="if(event.key==='Enter') document.getElementById('add-transaction-form').requestSubmit()"></td>
                            <td><button type="submit" form="add-transaction-form" class="btn btn-sm btn-primary w-100">Add</button></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>

        <!-- Charts Row 2: Transaction Details -->
        <div class="row mb-4">
            <div class="col-md-6 mb-4">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="incomeTransPieChart"></canvas>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="chart-container" style="height: 350px;">
                    <canvas id="expenseTransPieChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirm Delete</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">Are you sure you want to delete this transaction?</div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Manage Cards Modal -->
    <div class="modal fade" id="manageCardsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5>Manage Cards</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="cards-list" class="mb-3">
                        {% for card in cards %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ card.name }} {% if !card.is_active %}(Inactive){% endif %}</span>
                            <button class="btn btn-sm {% if card.is_active %}btn-outline-danger{% else %}btn-outline-success{% endif %}" onclick="toggleCard({{ card.id }})">
                                {% if card.is_active %}Deactivate{% else %}Activate{% endif %}
                            </button>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="input-group">
                        <input type="text" id="new-card-name" class="form-control" placeholder="New Card Name">
                        <button class="btn btn-primary" onclick="addCard()">Add</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/public/js/autocomplete.js"></script>
    <script src="/public/js/charts.js"></script>
    <script src="/public/js/editing.js"></script>
    <script src="/public/js/budget.js"></script>
    <script>
        // Data Bridge: Askama to JavaScript
        const categories = [{% for c in categories %}{id: {{c.id}}, name: "{{c.name}}", is_active: {{c.is_active}} }{% if !loop.last %},{% endif %}{% endfor %}];
        const cards = [{% for c in cards %}{id: {{c.id}}, name: "{{c.name}}", is_active: {{c.is_active}} }{% if !loop.last %},{% endif %}{% endfor %}];
        const currentMonth = "{{ month }}";
        const currentBudgetRows = [{% for r in budget_rows %}{id: {{r.category_id}}, name: "{{r.category_name}}", limit: {{r.limit_dollars}}, spent: {{r.spent_dollars}}, color: "{{r.category_color}}", is_income: {{r.is_income}}, is_active: {{r.is_active}} }{% if !loop.last %},{% endif %}{% endfor %}];
        const allTransactions = [{% for t in transactions %}{ id: {{t.id}}, category_id: {{t.category_id}}, amount: {{t.amount_dollars}}, is_income: {{t.is_income}}, notes: "{{t.notes}}", category_name: "{{t.category_name}}", category_color: "{{t.category_color}}" }{% if !loop.last %},{% endif %}{% endfor %}];

        // Page-specific setup
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Autocomplete for the "Add" footer
            try {
                const activeCategories = categories.filter(c => c.is_active);
                const activeCards = cards.filter(c => c.is_active);
                console.log(`Initializing autocomplete: ${activeCategories.length} active categories, ${activeCards.length} active cards.`);

                new Autocomplete(document.getElementById('add-category-input'), activeCategories, (item) => {
                    document.getElementById('add-category-id').value = item ? item.id : "";
                });
                new Autocomplete(document.getElementById('add-card-input'), activeCards, (item) => {
                    document.getElementById('add-card-id').value = item ? item.id : "";
                });
            } catch (e) { console.error("Autocomplete init failed:", e); }

            // Add Transaction Form Validation
            const transForm = document.getElementById('add-transaction-form');
            if (transForm) {
                transForm.addEventListener('submit', function(e) {
                    const catId = document.getElementById('add-category-id').value;
                    const cardId = document.getElementById('add-card-id').value;
                    if (!catId || !cardId) {
                        e.preventDefault();
                        alert('Please select a valid Category and Card.');
                    }
                });
            }
        });
    </script>
</body>
</html>